---

---

<div id="giscus-container" class="mt-12" data-loaded="false"></div>
<noscript>请开启 JavaScript 以查看评论。</noscript>

<!-- 延迟加载 giscus，进入视口后再请求脚本 -->
<script is:inline>
  document.addEventListener("astro:page-load", () => {
    const container = /** @type {HTMLDivElement | null} */ (document.querySelector("#giscus-container"));
    if (!container) return;

    const html = document.documentElement;
    /** @type {MutationObserver | null} */
    let themeObserver = null;

    const resolveTheme = () => (html.getAttribute("data-theme-type") === "dark" ? "dark" : "light");

    const postThemeToIframe = () => {
      const iframe = /** @type {HTMLIFrameElement | null} */ (container.querySelector("iframe.giscus-frame"));
      if (!iframe || !iframe.contentWindow) return false;
      iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: resolveTheme() } } }, "https://giscus.app");
      return true;
    };

    const ensureThemeSync = () => {
      if (!postThemeToIframe()) {
        requestAnimationFrame(ensureThemeSync);
        return;
      }

      if (themeObserver) return;

      themeObserver = new MutationObserver(() => {
        postThemeToIframe();
      });
      themeObserver.observe(html, { attributes: true, attributeFilter: ["data-theme-type"] });
    };

    const loadGiscus = () => {
      if (container.dataset.loaded === "true") return;

      const script = document.createElement("script");
      script.src = "https://giscus.app/client.js";
      script.async = true;
      script.crossOrigin = "anonymous";

      script.setAttribute("data-repo", "Duskydream/ShepherdsBlog");
      script.setAttribute("data-repo-id", "R_kgDOP0om7Q");
      script.setAttribute("data-category", "General");
      script.setAttribute("data-category-id", "DIC_kwDOP0om7c4Cv4dH");
      script.setAttribute("data-mapping", "pathname");
      script.setAttribute("data-strict", "0");
      script.setAttribute("data-reactions-enabled", "1");
      script.setAttribute("data-emit-metadata", "0");
      script.setAttribute("data-input-position", "bottom");
      script.setAttribute("data-theme", "light_tritanopia");
      script.setAttribute("data-lang", "zh-CN");
      script.setAttribute("data-loading", "lazy");

      script.addEventListener("load", () => {
        requestAnimationFrame(ensureThemeSync);
      });

      container.appendChild(script);
      container.dataset.loaded = "true";
    };

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            observer.disconnect();
            loadGiscus();
          }
        });
      },
      { rootMargin: "200px" },
    );

    observer.observe(container);
  });
</script>
