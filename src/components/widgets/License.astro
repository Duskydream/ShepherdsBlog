---
import dayjs from "@utils/dayjs";
import { USER_NAME, DATE_FORMAT, t } from "@config";
import type { PostData } from "@interfaces/data";
import { Icon } from "astro-icon/components";
import PostFilter from "./PostFilter.astro";

const { title, url, pubDate, badge, categories = [], tags = [], word, time } = Astro.props as PostData;
const displayDate = pubDate ? dayjs(pubDate).format(DATE_FORMAT) : "";

const socialLinks = [
  {
    name: "X (Twitter)",
    icon: "ri:twitter-x-line",
    url: `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`,
  },
  {
    name: "Telegram",
    icon: "ri:telegram-line",
    url: `https://telegram.me/share/url?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`,
  },
  {
    name: "Facebook",
    icon: "ri:facebook-circle-line",
    url: `https://facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
  },
  {
    name: "Email",
    icon: "ri:mail-line",
    url: `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(url)}`,
  },
  {
    name: "Copy Link",
    icon: "ri:file-copy-line",
    url: "#",
    isCopy: true,
  },
];
---

<hr />
<div class="container p-0">
  <div class="text-right text-sm text-base-content/60 italic mb-2">
    <Icon name="ri:heart-line" class="w-4 h-4 inline-block align-text-bottom text-error" /> Thanks for reading!
  </div>

  <div class="card bg-base-200 overflow-visible">
    <div class="card-body relative p-4 sm:p-6 lg:p-8">
      <!-- License Icon -->
      <div class="absolute -top-8 left-8">
        <div class="w-16 h-16 bg-primary flex items-center justify-center">
          <Icon name="ri:creative-commons-line" class="w-10 h-10 text-primary-content" />
        </div>
      </div>

      <!-- Article Metadata -->
      <div class="space-y-4">
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">{title}</h3>

        <!-- Stats Row -->
        <div class="flex flex-wrap gap-2 sm:gap-4 text-xs sm:text-sm opacity-75">
          {
            displayDate && (
              <span class="flex items-center gap-1">
                <Icon name="lucide:calendar" class="h-4 w-4" />
                {displayDate}
              </span>
            )
          }

          {
            badge && (
              <span class="flex items-center gap-1">
                <Icon name="lucide:bookmark" class="h-4 w-4" />
                {badge}
              </span>
            )
          }

          {
            word && time && (
              <div class="flex items-center gap-1">
                <Icon name="lucide:book-open" class="h-4 w-4" />
                <span>
                  {word} {t("label.wordCount")} · {time} {t("label.readTime")}
                </span>
              </div>
            )
          }
          <a href={url} class="flex items-center gap-1 hover:text-primary transition-colors">
            <Icon name="ri:links-line" class="w-4 h-4" />
          </a>
        </div>

        <!-- Categories and Tags -->
        <div class="mt-4">
          <PostFilter categories={categories} tags={tags} />
          <!-- License Info -->
          <hr class="my-4" />
          <p class="text-sm opacity-75"></p>
          © {USER_NAME} |
          <a
            href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed"
            target="_blank"
            rel="noopener noreferrer"
            class="hover:text-primary transition-colors"
          >
            CC BY-NC-SA 4.0
          </a>
        </div>
      </div>

      <!-- Share Button -->
      <div class="flex justify-end mt-4">
        <button class="btn share-trigger" onclick="share_modal.showModal()">
          {t("label.share")}
          <Icon name="ri:share-line" class="w-5 h-5" />
        </button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <dialog id="share_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-2xl">
      <h3 class="font-bold text-lg sm:text-xl mb-6 text-center">
        {t("label.shareCard")}
      </h3>
      <div class="flex flex-wrap gap-4 justify-center">
        {
          socialLinks.map(({ name, icon, url, isCopy }) => (
            isCopy ? (
              <button
                class="btn btn-circle btn-lg transition-transform hover:scale-110 share-option-btn copy-link-btn"
                title={name}
                data-url={Astro.props.url}
              >
                <span class="sr-only">{name}</span>
                <Icon name={icon} class="w-6 h-6 text-white" />
              </button>
            ) : (
              <a
                href={url}
                class="btn btn-circle btn-lg transition-transform hover:scale-110 share-option-btn"
                target="_blank"
                rel="noopener noreferrer"
                title={name}
              >
                <span class="sr-only">{name}</span>
                <Icon name={icon} class="w-6 h-6 text-white" />
              </a>
            )
          ))
        }
      </div>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost hover:scale-105 transition-transform">
            {t("label.close")}
          </button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>{t("label.close")}</button>
    </form>
  </dialog>
</div>

<style>
  .share-trigger {
    background-color: #111827 !important;
    color: #f9fafb !important;
    border: none !important;
  }

  .share-trigger:hover {
    background-color: #1f2937 !important;
  }

  #share_modal .share-option-btn {
    background-color: #111827 !important;
    color: #f9fafb !important;
    border: none !important;
  }

  #share_modal .share-option-btn:hover {
    background-color: #1f2937 !important;
  }

  .modal-backdrop button {
    cursor: default;
    width: 100%;
    height: 100%;
    opacity: 0;
  }

  /* Remove underlines from PostFilter buttons */
  :global(.card-body .btn-category),
  :global(.card-body .btn-tag) {
    text-decoration: none;
  }
</style>

<script>
  document.addEventListener("astro:page-load", () => {
    const copyButtons = document.querySelectorAll(".copy-link-btn");
    
    copyButtons.forEach((button) => {
      button.addEventListener("click", async () => {
        const url = button.getAttribute("data-url") || window.location.href;
        
        try {
          await navigator.clipboard.writeText(url);
          
          // 创建提示消息
          const toast = document.createElement("div");
          toast.className = "toast toast-top toast-center";
          toast.innerHTML = `
            <div class="alert alert-success">
              <span>已复制网址</span>
            </div>
          `;
          document.body.appendChild(toast);
          
          // 2秒后移除提示
          setTimeout(() => {
            toast.remove();
          }, 2000);
        } catch (err) {
          console.error("Failed to copy:", err);
          // 如果复制失败，显示错误提示
          const toast = document.createElement("div");
          toast.className = "toast toast-top toast-center";
          toast.innerHTML = `
            <div class="alert alert-error">
              <span>复制失败</span>
            </div>
          `;
          document.body.appendChild(toast);
          
          setTimeout(() => {
            toast.remove();
          }, 2000);
        }
      });
    });
  });
</script>
