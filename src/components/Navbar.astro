---
import { Icon } from "astro-icon/components";
import { SITE_TITLE, SITE_MENU } from "../config";
import ProfileCard from "@components/ProfileCard.astro";

// Get current path to determine active link
const currentPath = Astro.url.pathname;

// Type safely process SITE_MENU before rendering
type SubMenuItem = {
  id: string;
  text: string;
  href: string;
  svg: string;
  target?: string;
};

type MenuItem = {
  id: string;
  text: string;
  href: string;
  svg: string;
  target?: string;
  subItems?: SubMenuItem[];
};

// Ensure the menu is properly typed
const typedMenu = SITE_MENU as MenuItem[];
---


<!-- Mobile top navbar (visible only on small screens) -->
<input id="menu-toggle" type="checkbox" class="hidden" />
<nav id="navbar" class="md:hidden fixed top-0 left-0 right-0 z-40 bg-base-100 border-b">
  <div class="flex items-center justify-between px-3 py-2">
    <div class="flex items-center gap-2">
      <label for="menu-toggle" class="btn btn-ghost btn-square p-2">
        <Icon name="lucide:menu" class="w-5 h-5" />
      </label>
      <a href="/" class="btn btn-ghost text-lg font-semibold px-0">{SITE_TITLE}</a>
    </div>
  </div>
</nav>

<!-- Mobile off-canvas header menu toggled by checkbox -->
<div id="header-menu" class="md:hidden fixed top-0 left-0 h-full w-64 bg-base-100 z-50 transform -translate-x-full transition-transform">
  <div class="p-4">
    <ProfileCard />

<!-- Desktop left sidebar -->
<aside class="hidden md:flex md:flex-col md:items-start md:justify-start w-56 flex-shrink-0 z-40 bg-base-100 p-4 border-r border-base-300/20 overflow-y-auto">
  <!-- Profile (shows in sidebar on desktop) -->
  <div class="w-full mb-4">
    <ProfileCard />
  </div>
</aside>

<script>
  document.addEventListener("astro:page-load", () => {
    let lastScrollY = window.scrollY;
    const navbar = document.getElementById("navbar");
    const headerMenu = document.getElementById("header-menu");
    const menuToggle = document.getElementById("menu-toggle") as HTMLInputElement | null;

    if (!navbar || !headerMenu || !menuToggle) return;

    // Toggle menu visibility
    menuToggle.addEventListener("change", () => {
      if (menuToggle.checked) {
        headerMenu.classList.remove("-translate-x-full");
        headerMenu.classList.add("translate-x-0");
      } else {
        headerMenu.classList.add("-translate-x-full");
        headerMenu.classList.remove("translate-x-0");
      }
    });

    function handleScroll() {
      if (!navbar || !headerMenu || !menuToggle) return;

      if (window.scrollY > lastScrollY && window.scrollY > 50) {
        navbar.classList.add("-translate-y-full", "duration-500");
        navbar.classList.remove("translate-y-0");

        // Close menu when hiding navbar
        if (menuToggle.checked) {
          menuToggle.checked = false;
          headerMenu.classList.add("-translate-x-full");
          headerMenu.classList.remove("translate-x-0");
        }
      } else if (window.scrollY < lastScrollY) {
        navbar.classList.remove("-translate-y-full");
        navbar.classList.add("translate-y-0", "duration-300");
      }

      lastScrollY = window.scrollY;
    }

    // Throttle scroll event for better performance
    let ticking = false;
    window.addEventListener("scroll", () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          handleScroll();
          ticking = false;
        });
        ticking = true;
      }
    });

    // Close menu when clicking outside
    document.addEventListener("click", (event) => {
      if (!navbar || !headerMenu || !menuToggle) return;

      const target = event.target as Node;
      if (!navbar.contains(target) && headerMenu.classList.contains("translate-x-0")) {
        menuToggle.checked = false;
        headerMenu.classList.add("-translate-x-full");
        headerMenu.classList.remove("translate-x-0");
      }
    });

    // Close menu when clicking menu items
    const menuItems = document.querySelectorAll("#header-menu a");
    menuItems.forEach((item) => {
      item.addEventListener("click", () => {
        if (!headerMenu || !menuToggle) return;

        if (menuToggle.checked) {
          menuToggle.checked = false;
          headerMenu.classList.add("-translate-x-full");
          headerMenu.classList.remove("translate-x-0");
        }
      });
    });
  });
</script>
