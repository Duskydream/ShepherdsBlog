---
import BaseLayout from "@/layouts/BaseLayout.astro";
import MainCard from "@/components/MainCard.astro";
import PostMetadata from "@/components/widgets/PostMetadata.astro";
import EncryptWrapper from "@/components/widgets/EncryptWrapper.astro";
import { Icon } from "astro-icon/components";
import dayjs from "@utils/dayjs";
import { DATE_FORMAT } from "@/config";

export async function getStaticPaths() {
  const { getCollection } = await import("astro:content");
  const logs = await getCollection("log");
  return logs.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, remarkPluginFrontmatter } = await entry.render();
const displayDate = dayjs(entry.data.date).format(DATE_FORMAT);
const updatedDate = entry.data.updated ? dayjs(entry.data.updated).format(DATE_FORMAT) : "";

// 是否加密日志
const isEncrypted = entry.data.encrypted === true;
---

<BaseLayout title={entry.data.title} isPost={true}>
  <MainCard title={entry.data.title} description={displayDate} textOverlay="LOG" infoIcon="lucide:book-open">
    <div class="space-y-6">
      <!-- 标题 -->
      <section>
        <h1 class="text-3xl font-bold mb-2">{entry.data.title}</h1>
        <p class="text-base-content/60 flex items-center gap-2">
          <Icon name="lucide:calendar" class="w-4 h-4" />
          {displayDate}
        </p>
      </section>

      <!-- 新增：日志元数据（阅读时长、阅读人数、更新时间） -->
      <PostMetadata
        readingTime={remarkPluginFrontmatter?.readingTime}
        wordCount={remarkPluginFrontmatter?.totalCharCount}
        showViewCount={true}
        updatedDate={updatedDate}
        pubDate={displayDate}
        pageKey={`/log/${entry.slug}`}
      />

      <!-- 正文 -->
      <section>
        <article class="prose max-w-none text-base-content/80">
          {isEncrypted ? (
            <EncryptWrapper postId={entry.slug}>
              <Content />
            </EncryptWrapper>
          ) : (
            <Content />
          )}
        </article>
      </section>

      <!-- 返回列表 -->
      <section>
        <a href="/log/" class="btn btn-sm btn-outline gap-2">
          <Icon name="lucide:arrow-left" class="w-4 h-4" />
          返回日志列表
        </a>
      </section>
    </div>
  </MainCard>
</BaseLayout>
