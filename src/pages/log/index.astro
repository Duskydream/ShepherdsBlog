---
import BaseLayout from "@/layouts/BaseLayout.astro";
import MainCard from "@/components/MainCard.astro";
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";
import { t } from "@/config";

const logs = await getCollection("log");
const sortedLogs = logs.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const logsByDate = new Map<string, Map<string, typeof sortedLogs[0][]>>();
for (const log of sortedLogs) {
  const year = log.data.date.getFullYear().toString();
  const month = (log.data.date.getMonth() + 1).toString().padStart(2, '0');
  if (!logsByDate.has(year)) logsByDate.set(year, new Map());
  const yearMap = logsByDate.get(year)!;
  if (!yearMap.has(month)) yearMap.set(month, []);
  yearMap.get(month)!.push(log);
}
const years = Array.from(logsByDate.keys()).sort((a, b) => parseInt(b) - parseInt(a));

const getMonthName = (month: string): string => {
  const monthIndex = parseInt(month);
  return t(`months.${monthIndex}`);
};
---

<BaseLayout title="Logs">
  <MainCard title="Logs">
    <div class="space-y-10 mb-8">
      <section class="archives-container" id="archives">
        <div class="flex items-center justify-between gap-3 mb-4">
          <div class="flex items-center gap-2">
            <Icon name="lucide:archive" class="w-5 h-5 text-accent" />
            <h2 class="text-lg font-semibold">Timeline</h2>
          </div>
          <div class="badge badge-accent">{sortedLogs.length}</div>
        </div>

        {
          years.length > 0 ? (
            <div class="max-h-[75vh] overflow-y-auto pr-2">
              <div class="archives-timeline">
                {years.map((year) => (
                  <details class="timeline-year archive-year" open>
                    <summary class="year-header cursor-pointer list-none flex items-center gap-3">
                      <Icon name="lucide:chevron-right" class="w-5 h-5 opacity-70 year-chevron" />
                      <span class="year-badge">{year}</span>
                    </summary>

                    <div class="year-content">
                      {Array.from(logsByDate.get(year)!.entries())
                        .sort((a, b) => parseInt(b[0]) - parseInt(a[0]))
                        .map(([month, logs]) => (
                          <div class="timeline-month">
                            <div class="month-title">
                              <Icon name="lucide:calendar" class="month-icon" />
                              <span>{getMonthName(month)}</span>
                              <span class="month-count">{logs.length}</span>
                            </div>

                            <ul class="archive-posts">
                              {logs.map((log) => (
                                <li class="archive-item">
                                  <div class="archive-marker">
                                    {log.data.encrypted ? (
                                      <Icon name="lucide:lock" class="archive-icon" />
                                    ) : (
                                      <Icon name="lucide:file-text" class="archive-icon" />
                                    )}
                                  </div>
                                  <a href={`/log/${log.slug}/`} class="archive-card">
                                    <div class="archive-date">{log.data.date.toISOString().slice(0, 10)}</div>
                                    <div class="archive-title">{log.data.title}</div>
                                  </a>
                                </li>
                              ))}
                            </ul>
                          </div>
                        ))}
                    </div>
                  </details>
                ))}
              </div>
            </div>
          ) : (
            <div class="empty-state">
              <Icon name="lucide:archive" class="empty-icon" />
              <p class="empty-text">No logs</p>
            </div>
          )
        }
      </section>
    </div>
  </MainCard>
</BaseLayout>
