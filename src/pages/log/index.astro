---
import BaseLayout from "@/layouts/BaseLayout.astro";
import MainCard from "@/components/MainCard.astro";
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";

const logs = await getCollection("log");
const sortedLogs = logs.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// small utilities: generate text preview and extract first image from markdown
function makePreview(md: string | undefined) {
  if (!md) return "";
  return (
    md
      .replace(/!\[.*?\]\(.*?\)/g, "")
      .replace(/\[([^\]]+)\]\([^\)]+\)/g, "$1")
      .replace(/`{1,3}[^`]*`{1,3}/g, "")
      .replace(/#{1,6}\s+/g, "")
      .replace(/\n/g, " ")
      .slice(0, 150) + "..."
  );
}

function extractFirstImage(md: string | undefined) {
  if (!md) return undefined;
  const m = md.match(/!\[[^\]]*\]\(([^)\s]+)(?:\s+"[^"]*")?\)/);
  return m ? m[1] : undefined;
}

const previews = sortedLogs.map((entry) => {
  const isEncrypted = entry.data.encrypted === true;
  const preview = isEncrypted ? "" : makePreview(entry.body);
  const imageFromFront = (entry.data as any)?.image;
  const image = isEncrypted ? undefined : imageFromFront || extractFirstImage(entry.body);
  return {
    slug: entry.slug,
    date: entry.data.date.toISOString().slice(0, 10),
    title: entry.data.title,
    preview,
    image,
    encrypted: isEncrypted,
  };
});
---

<BaseLayout title="Logs">
  <MainCard title="Logs" description="个人时间线">
    <div class="space-y-10 mb-8">
      <section>
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <Icon name="lucide:clock" class="w-6 h-6 text-primary" />
          <span>Timeline</span>
        </h2>

        <div class="bg-base-200 rounded-xl p-6 overflow-x-auto">
          <div class="relative">
            <div
              class="hidden md:block absolute left-1/2 top-0 bottom-0 w-px bg-base-300 -translate-x-1/2"
              aria-hidden="true"
            />

            <ul class="flex flex-col gap-8">
              {
                previews.map((p, i) => {
                  const isRight = i % 2 === 1;

                  return (
                    <li class="relative">
                      <div
                        class="hidden md:block absolute left-1/2 top-4 w-3 h-3 rounded-full bg-primary -translate-x-1/2"
                        aria-hidden="true"
                      />

                      <div class={`flex ${isRight ? "md:justify-end" : "md:justify-start"}`}>
                        <div
                          class={`relative flex gap-4 w-full md:w-[calc(50%-2rem)] ${
                            isRight ? "md:flex-row-reverse" : ""
                          }`}
                        >
                          <div class="flex flex-col items-center">
                            <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-primary-content text-xl">
                              {i + 1}
                            </div>
                            <div class="w-0.5 flex-1 bg-base-300 mt-2 md:hidden" />
                          </div>



                          <div class="flex-1">
                            <div class={`text-sm text-base-content/60 mb-1 ${isRight ? "md:text-right" : ""}`}>
                              {p.date}
                            </div>
                            <h3 class={`text-lg font-bold ${isRight ? "md:text-right" : ""}`}>{p.title}</h3>
                            {p.encrypted ? (
                              <div
                                class={`flex items-center gap-2 mt-2 text-base-content/60 ${
                                  isRight ? "md:justify-end" : ""
                                }`}
                              >
                                <Icon name="lucide:lock" class="w-4 h-4" />
                                <span class="text-sm">此内容已加密</span>
                              </div>
                            ) : (
                              <article
                                class={`prose max-w-none text-base-content/80 mt-2 line-clamp-3 ${
                                  isRight ? "md:text-right" : ""
                                }`}
                              >
                                <p>{p.preview}</p>
                              </article>
                            )}
                          </div>

                          <div class="flex items-start">
                            <a href={`/log/${p.slug}/`} class="btn btn-sm btn-outline gap-2">
                              <Icon name="lucide:external-link" class="w-4 h-4" />
                              查看详情
                            </a>
                          </div>
                        </div>
                      </div>
                    </li>
                  );
                })
              }
            </ul>
          </div>
        </div>
      </section>
    </div>
  </MainCard>
</BaseLayout>
