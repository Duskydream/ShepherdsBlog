---
import BaseLayout from "@/layouts/BaseLayout.astro";
import MainCard from "@/components/MainCard.astro";
import { Icon } from "astro-icon/components";
---

<BaseLayout title="Anime">
  <MainCard title="Reviews" description="动画与游戏评价">
    <div class="max-w-6xl mx-auto px-4 space-y-6">
      <!-- 搜索框 -->
      <div class="flex justify-center">
        <div class="relative w-full max-w-md">
          <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
            <Icon name="lucide:search" class="w-4 h-4 text-gray-400" />
          </div>
          <input
            type="text"
            id="search"
            placeholder="搜索..."
            class="w-full pl-9 pr-4 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:border-gray-900 bg-white transition-colors hover:border-gray-400"
          />
        </div>
      </div>

      <!-- 媒体类型切换 Tab -->
      <div class="flex justify-center gap-8">
        <button
          data-media="anime"
          class="media-btn pb-2 text-base font-bold transition-all text-gray-900 border-b-2 border-gray-900"
        >
          Anime
        </button>
        <button
          data-media="game"
          class="media-btn pb-2 text-base font-normal transition-all text-gray-400 border-b-2 border-transparent hover:text-gray-600"
        >
          Game
        </button>
      </div>

      <!-- 状态切换 Pill 按钮 -->
      <div class="flex justify-center gap-3">
        <button
          data-status="watching"
          class="status-btn px-6 py-2 text-sm font-medium rounded-full transition-all bg-gray-900 text-white"
        >
          In Progress
        </button>
        <button
          data-status="wish"
          class="status-btn px-6 py-2 text-sm font-medium rounded-full transition-all bg-gray-100 text-gray-600 hover:bg-gray-200"
        >
          Backlog
        </button>
        <button
          data-status="watched"
          class="status-btn px-6 py-2 text-sm font-medium rounded-full transition-all bg-gray-100 text-gray-600 hover:bg-gray-200"
        >
          Completed
        </button>
      </div>

      <!-- 作品卡片区域 - 一行两个 -->
      <div id="content-area" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="col-span-full text-center py-12 text-sm text-gray-500">加载中...</div>
      </div>
    </div>

    <script type="module" is:inline>
      // ============ 配置 ============
      let _envApi;
      try {
        _envApi = (typeof import.meta === "object" && import.meta?.env?.PUBLIC_BANGUMI_API) || undefined;
      } catch {
        /* ignore */
      }
      const API = (window.__BANGUMI_API__ || _envApi || "/api/bangumi").replace(/\/$/, "");
      const STATIC_FALLBACK = "/data/bangumi.json";
      const CACHE_KEY = "bangumi_cache_v3";
      const CLIENT_TTL = 30 * 60 * 1000;

      // 两层筛选状态
      let mediaType = "anime"; // anime | game
      let status = "watching"; // watching | wish | watched
      let data = { watching: [], wish: [], watched: [] };
      let expanded = null;
      let isFetching = false;
      let fetchAbortController = null;

      const search = document.getElementById("search");
      const area = document.getElementById("content-area");

      // ============ 缓存管理 ============
      function readCache() {
        try {
          const raw = localStorage.getItem(CACHE_KEY);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (parsed.__cachedAt && Date.now() - parsed.__cachedAt < CLIENT_TTL) {
            return { watching: parsed.watching || [], wish: parsed.wish || [], watched: parsed.watched || [] };
          }
        } catch (e) {
          console.debug("Cache read failed", e);
        }
        return null;
      }

      function saveCache(obj) {
        try {
          localStorage.setItem(CACHE_KEY, JSON.stringify({ ...obj, __cachedAt: Date.now() }));
        } catch (e) {
          console.debug("Cache save failed", e);
        }
      }

      // ============ 数据获取 ============
      async function fetchData(force = false) {
        if (isFetching) {
          console.debug("[bangumi] Request already in progress");
          return null;
        }

        if (!force) {
          const cached = readCache();
          if (cached) {
            data = cached;
            render();
            return { cachedAt: Date.now(), servedFrom: "cache" };
          }
        }

        isFetching = true;
        fetchAbortController = new AbortController();

        try {
          const res = await fetch(`${API}?t=${Date.now()}`, {
            cache: "no-store",
            signal: fetchAbortController.signal,
          });

          if (!res.ok) throw new Error(`API status ${res.status}`);

          const json = await res.json();
          data = {
            watching: json.watching || [],
            wish: json.wish || [],
            watched: json.watched || [],
          };
          saveCache(data);
          render();

          return {
            cachedAt: json.cachedAt || Date.now(),
            servedFrom: json.servedFrom || "api",
          };
        } catch (primaryErr) {
          if (primaryErr.name === "AbortError") {
            console.debug("[bangumi] Request cancelled");
            return null;
          }

          console.warn("[bangumi] API failed, trying static fallback:", primaryErr.message);

          try {
            const resStatic = await fetch(`${STATIC_FALLBACK}?t=${Date.now()}`, {
              cache: "no-store",
              signal: fetchAbortController.signal,
            });

            if (!resStatic.ok) throw new Error(`Fallback status ${resStatic.status}`);

            const json = await resStatic.json();
            data = {
              watching: json.watching || [],
              wish: json.wish || [],
              watched: json.watched || [],
            };
            saveCache(data);
            render();

            return { cachedAt: json.cachedAt, servedFrom: "static" };
          } catch (fallbackErr) {
            if (fallbackErr.name === "AbortError") return null;

            console.error("[bangumi] All sources failed:", fallbackErr.message);

            if (!data.watching.length && !data.wish.length && !data.watched.length) {
              area.innerHTML =
                '<div class="col-span-full text-center py-8 text-sm text-red-500">无法加载数据，请检查网络连接后刷新页面</div>';
            }
            return null;
          }
        } finally {
          isFetching = false;
          fetchAbortController = null;
        }
      }

      // ============ 渲染 ============
      window.toggle = (id) => {
        expanded = expanded === id ? null : id;
        render();
      };

      function card(item) {
        const t = item.subject?.name_cn || item.subject?.name || "?";
        const img = item.subject?.images?.large || item.subject?.images?.common || "";
        const id = item.subject?.id || 0;
        const cmt = item.comment?.trim() || "";
        const airDate = item.subject?.date || ""; // 发行日期
        const open = expanded === id;

        return `
<div class="bg-white rounded-lg border-2 border-gray-200 hover:border-gray-400 transition-all overflow-hidden">
  <div class="flex gap-4 p-5 cursor-pointer" onclick="toggle(${id})">
    <div class="w-24 rounded-lg overflow-hidden bg-gray-100 flex-shrink-0 shadow-lg" style="aspect-ratio: 2/3;">
      ${img ? `<img src="${img}" alt="${t}" class="w-full h-full object-cover"/>` : '<div class="flex items-center justify-center h-full text-3xl">📺</div>'}
    </div>
    <div class="flex-1 min-w-0 flex flex-col">
      <h3 class="font-semibold text-lg mb-2 line-clamp-2 text-gray-900">${t}</h3>
      ${airDate ? `<p class="text-sm text-gray-500 mb-2">发行日期: ${airDate}</p>` : ""}
      ${cmt ? `<p class="text-sm text-gray-600 line-clamp-3 flex-1">${cmt.slice(0, 120)}${cmt.length > 120 ? "..." : ""}</p>` : '<p class="text-sm text-gray-400 italic">No review yet</p>'}
      <div class="mt-3 text-xs text-gray-400 flex items-center gap-1">
        <svg class="w-4 h-4 transition-transform ${open ? "rotate-180" : ""}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
        <span>${open ? "收起" : "展开详情"}</span>
      </div>
    </div>
  </div>
  <div style="max-height:${open ? "2000px" : "0"}" class="overflow-hidden transition-all duration-300">
    <div class="px-5 pb-5 pt-2 border-t-2 border-gray-100">
      ${cmt ? `<div class="mb-4 bg-gray-50 rounded-lg p-4 border border-gray-200"><p class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">${cmt}</p></div>` : ""}
      <a href="https://bgm.tv/subject/${id}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-4 py-2 bg-white border-2 border-gray-900 text-gray-900 rounded-md text-sm font-medium transition-all hover:bg-gray-900 hover:text-white">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
        <span>View on Bangumi</span>
      </a>
    </div>
  </div>
</div>`;
      }

      function render() {
        // 获取当前状态的数据
        let list = data[status] || [];

        // 根据媒介类型过滤
        const typeFilter = mediaType === "anime" ? 2 : 4;
        list = list.filter((x) => x.subject?.type === typeFilter);

        // 搜索过滤
        const term = search.value.toLowerCase().trim();
        if (term) {
          list = list.filter((x) => (x.subject?.name_cn || x.subject?.name || "").toLowerCase().includes(term));
        }

        if (!list.length) {
          area.innerHTML = '<div class="col-span-full text-center py-12 text-sm text-gray-400">暂无内容</div>';
          return;
        }

        area.innerHTML = list.map(card).join("");
      }

      async function setMediaType(type) {
        mediaType = type;
        expanded = null;
        document.querySelectorAll(".media-btn").forEach((b) => {
          const active = b.dataset.media === type;
          if (active) {
            b.className = "media-btn pb-2 text-base font-bold transition-all text-gray-900 border-b-2 border-gray-900";
          } else {
            b.className =
              "media-btn pb-2 text-base font-normal transition-all text-gray-400 border-b-2 border-transparent hover:text-gray-600";
          }
        });
        await fetchData(true);
      }

      async function setStatus(newStatus) {
        status = newStatus;
        expanded = null;
        document.querySelectorAll(".status-btn").forEach((b) => {
          const active = b.dataset.status === newStatus;
          if (active) {
            b.className = "status-btn px-6 py-2 text-sm font-medium rounded-full transition-all bg-gray-900 text-white";
          } else {
            b.className =
              "status-btn px-6 py-2 text-sm font-medium rounded-full transition-all bg-gray-100 text-gray-600 hover:bg-gray-200";
          }
        });
        await fetchData(true);
      }

      document
        .querySelectorAll(".media-btn")
        .forEach((b) => b.addEventListener("click", () => setMediaType(b.dataset.media)));

      document
        .querySelectorAll(".status-btn")
        .forEach((b) => b.addEventListener("click", () => setStatus(b.dataset.status)));

      let timer;
      search.addEventListener("input", () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
          expanded = null;
          render();
        }, 300);
      });

      // ============ 初始化 ============
      (async () => {
        area.innerHTML = '<div class="text-center py-12 text-sm text-gray-500">加载中...</div>';

        // 首次加载强制刷新
        await fetchData(true);

        // 初始化为动画+在看
        setMediaType("anime");
        setStatus("watching");
      })();
    </script>
  </MainCard>
</BaseLayout>
