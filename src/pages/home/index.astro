---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Icon } from "astro-icon/components";
import MainCard from "@/components/MainCard.astro";
import GitHubCalendar from "@/components/GitHubCalendar.astro";
import { getCollection } from "astro:content";
import { getAllPosts } from "@/utils/blogUtils";
import { t } from "@/config";
import fs from "node:fs/promises";
import path from "node:path";

// Get latest blogs
const allPosts = await getAllPosts();
const latestBlogs = allPosts.slice(0, 3);

// Get latest logs
const logs = await getCollection("log");
const sortedLogs = logs.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
const latestLogs = sortedLogs.slice(0, 3);

// Get anime data
type BangumiItem = {
  subject: {
    images: {
      medium: string;
    };
    name: string;
    name_cn?: string;
    short_summary?: string;
  };
};

type BangumiData = {
  watching: BangumiItem[];
};

let bangumiData: BangumiData = { watching: [] };
try {
  const bangumiPath = path.resolve("public/data/bangumi.json");
  const bangumiContent = await fs.readFile(bangumiPath, "utf-8");
  bangumiData = JSON.parse(bangumiContent) as BangumiData;
} catch {
  bangumiData = { watching: [] };
}
const watchingAnime: BangumiItem[] = bangumiData.watching.slice(0, 3);
---

<BaseLayout title="Home">
  <!-- About Section -->
  <MainCard title="About Shepherd" description="About me">
    <div class="space-y-6 mb-6">
      <!-- Profile Section -->
      <section class="flex flex-col md:flex-row gap-8 items-center md:items-start">
        <div class="avatar">
          <div
            class="w-24 h-24 md:w-32 md:h-32 rounded-xl ring ring-primary ring-offset-base-100 ring-offset-2 overflow-hidden"
          >
            <img
              src="https://pic1.imgdb.cn/item/65c1c9269f345e8d03080e8d.jpg"
              alt="Shepherd"
              width="128"
              height="128"
              loading="lazy"
              decoding="async"
              style="aspect-ratio: 1/1; background: linear-gradient(135deg, oklch(var(--b2)), oklch(var(--b3)));"
            />
          </div>
        </div>

        <div class="flex-1 text-center md:text-left">
          <h1 class="text-2xl md:text-3xl font-bold mb-2">Shepherd</h1>
          <p class="text-lg text-base-content/80 mb-4">CS Undergraduate & Developer</p>

          <div class="flex flex-wrap gap-3 justify-center md:justify-start mb-6">
            <a
              href="https://github.com/Duskydream"
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-sm btn-outline gap-2"
            >
              <Icon name="lucide:github" class="w-4 h-4" />
              <span>GitHub</span>
            </a>
            <a
              href="https://x.com/Lxzm1211"
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-sm btn-outline gap-2"
            >
              <Icon name="ri:twitter-x-fill" class="w-4 h-4" />
              <span>X(twitter)</span>
            </a>
            <a
              href="https://www.zhihu.com/people/ba-er-nian-lin-xi-zhi-meng"
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-sm btn-outline gap-2"
            >
              <Icon name="ri:zhihu-fill" class="w-4 h-4" />
              <span>Zhihu</span>
            </a>
            <a
              href="https://space.bilibili.com/198625051?spm_id_from=333.1007.0.0"
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-sm btn-outline gap-2"
            >
              <Icon name="ri:bilibili-fill" class="w-4 h-4" />
              <span>Bilibili</span>
            </a>
            <a
              href="https://leetcode.cn/u/confident-perlman7up/"
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-sm btn-outline gap-2"
            >
              <Icon name="ri:code-s-slash-line" class="w-4 h-4" />
              <span>LeetCode</span>
            </a>
            <a href="mailto:lxzm1211@outlook.com" class="btn btn-sm btn-outline gap-2">
              <Icon name="lucide:mail" class="w-4 h-4" />
              <span>Email</span>
            </a>
          </div>
        </div>
      </section>

      <!-- Updates Calendar -->
      <section>
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <Icon name="lucide:rocket" class="w-6 h-6 text-primary" />
          <span>Updates Calendar</span>
        </h2>
        <GitHubCalendar username="Duskydream" repo="ShepherdsBlog" />
      </section>
    </div>
  </MainCard>

  <!-- Blogs Section -->
  <MainCard title="Blogs" description="Latest posts">
    <div class="space-y-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {
          latestBlogs.map((post) => (
            <article class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow">
              <div class="card-body p-4">
                <div class="flex items-center gap-2 text-sm text-base-content/60 mb-2">
                  <Icon name="lucide:calendar" class="w-4 h-4" />
                  <time>{post.data.pubDate.toISOString().slice(0, 10)}</time>
                </div>
                <h3 class="card-title text-base font-bold line-clamp-2">
                  <a href={`/blog/${post.slug}`} class="hover:text-primary transition-colors">
                    {post.data.title}
                  </a>
                </h3>
                {post.data.description && (
                  <p class="text-base-content/80 text-sm line-clamp-3">{post.data.description}</p>
                )}
                <div class="card-actions justify-end mt-4">
                  <a href={`/blog/${post.slug}`} class="btn btn-primary btn-sm">
                    Read More
                  </a>
                </div>
              </div>
            </article>
          ))
        }
      </div>
      <div class="text-center">
        <a href="/blog" class="btn btn-outline">查看更多</a>
      </div>
    </div>
  </MainCard>

  <!-- Logs Section -->
  <MainCard title="Logs" description="Latest logs">
    <div class="space-y-4 mb-6">
      <div class="archives-timeline">
        {
          latestLogs.map((log) => (
            <div class="archive-item mb-2">
              <div class="archive-marker">
                {log.data.encrypted ? (
                  <Icon name="lucide:lock" class="archive-icon" />
                ) : (
                  <Icon name="lucide:file-text" class="archive-icon" />
                )}
              </div>
              <a href={`/log/${log.slug}/`} class="archive-card">
                <div class="archive-date">{log.data.date.toISOString().slice(0, 10)}</div>
                <div class="archive-title">{log.data.title}</div>
              </a>
            </div>
          ))
        }
      </div>
      <div class="text-center">
        <a href="/log" class="btn btn-outline">查看更多</a>
      </div>
    </div>
  </MainCard>

  <!-- Anime Section -->
  <MainCard title="Anime">
    <div class="space-y-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {
          watchingAnime.map((anime) => (
            <div class="card bg-base-100 shadow-xl">
              <div class="card-body p-4">
                <h3 class="card-title text-base font-bold line-clamp-2">
                  {anime.subject.name_cn || anime.subject.name}
                </h3>
                <p class="text-base-content/80 text-sm line-clamp-3">{anime.subject.short_summary}</p>
                <div class="card-actions justify-end mt-4">
                  <div class="badge badge-primary">在看</div>
                </div>
              </div>
            </div>
          ))
        }
      </div>
      <div class="text-center">
        <a href="/anime" class="btn btn-outline">查看更多</a>
      </div>
    </div>
  </MainCard>
</BaseLayout>
