---
import { SITE_TAB, SITE_DESCRIPTION, SITE_FAVICON, SITE_LANGUAGE, SITE_THEME } from "@config";
import { ClientRouter } from "astro:transitions";
import ElementCrossing from "astro-vtbot/components/ElementCrossing.astro";
import PointerOnNavigation from "astro-vtbot/components/PointerOnNavigation.astro";
import Header from "@components/Header.astro";
import ProfileCard from "@components/ProfileCard.astro";
import InlineSearch from "@components/InlineSearch.astro";
import InlineTOC from "@components/InlineTOC.astro";
import Footer from "@components/Footer.astro";
import Navbar from "@components/Navbar.astro";
import ReadingProgress from "@components/widgets/ReadingProgress.astro";
import ScrollToTop from "@components/widgets/ScrollToTop.astro";
import Giscus from "@components/Giscus.astro"; // 评论组件

const {
  title,
  image,
  description = SITE_DESCRIPTION,
  headings = [],
  showTOC = false,
  isIndexed = true,
  isPost = false, // 文章页传 true 显示评论
  loadKatex = false, // 是否加载 KaTeX CSS
  isEncrypted = false, // 是否加密文章
} = Astro.props;
---

<!doctype html>
<html lang={SITE_LANGUAGE} class="bg-white" data-theme={SITE_THEME.light} data-theme-type="light">
  <head>
    <ClientRouter />
    <ElementCrossing />
    <PointerOnNavigation />
    <Header title={title} description={description} favicon={SITE_FAVICON} image={image} loadKatex={loadKatex} />
    <title>{title ? title + " - " + SITE_TAB : SITE_TAB}</title>

    <!-- 不蒜子统计脚本 - 仅在文章页按需加载以避免在非文章页触发外部请求 -->
    {isPost && <script defer src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>}

    <!-- 注册 Service Worker 实现离线缓存 -->
    <script is:inline>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').catch(() => {});
        });
      }
    </script>

    <!-- 主题初始化（强制单一浅色主题，移除夜间模式） -->
    <script define:vars={{ SITE_THEME }} is:inline>
      (function () {
        try {
          const theme = SITE_THEME.light;
          document.documentElement.setAttribute("data-theme", theme);
          document.documentElement.setAttribute("data-theme-type", "light");
          // Ensure stored theme doesn't force dark mode
          localStorage.removeItem("theme");
        } catch (e) {
          // noop
        }
      })();
    </script>
  </head>

  <body class="flex flex-col min-h-screen" {...isIndexed ? { "data-pagefind-body": true } : {}}>
    <!-- 阅读进度条 -->
    <ReadingProgress />

    <!-- 导航栏 + 主体并列（非固定） -->
    <div class="relative">
      <div class="md:flex md:items-start md:gap-8">
        <Navbar headings={headings} showTOC={showTOC} />

        <!-- Full-width content container so cards can span the page -->
        <div class="flex-1 relative w-full max-w-none mx-auto mt-8 z-20 px-4 md:px-8">
          <div class="bg-base-100 min-h-screen p-4 md:p-8">

            <!-- 主内容 -->
            <main class="flex flex-col gap-4">
              <slot />
              {isPost && <Giscus />}
              <!-- 文章页显示评论 -->
            </main>
          </div>
          <Footer />
        </div>
      </div>

      <!-- 返回顶部按钮 -->
      <ScrollToTop />

      <!-- 主题同步 -->
      <script define:vars={{ SITE_THEME }} is:inline>
        // Ensure theme stays as light after partial navigations
        document.addEventListener("astro:after-swap", () => {
          const theme = SITE_THEME.light;
          document.documentElement.setAttribute("data-theme", theme);
          document.documentElement.setAttribute("data-theme-type", "light");
          localStorage.removeItem("theme");
        });
      </script>

      <!-- Swup.js scroll to anchor -->
      <script is:inline>
        document.addEventListener("astro:page-load", () => {
          if (window.location.hash) {
            const el = document.querySelector(window.location.hash);
            if (el) {
              el.scrollIntoView({ behavior: "smooth" });
            }
          }
        });
      </script>

      <!-- Fix anchor offset for fixed header: set scroll-padding-top dynamically -->
      <script is:inline>
        function updateScrollPaddingTop() {
          const navbar = document.getElementById("navbar");
          if (!navbar) return;
          const height = navbar.offsetHeight + 8; // small gap
          document.documentElement.style.setProperty("--frosti-scroll-padding-top", height + "px");
        }

        document.addEventListener("astro:page-load", () => updateScrollPaddingTop());
        window.addEventListener("resize", () => updateScrollPaddingTop());
        document.addEventListener("DOMContentLoaded", () => updateScrollPaddingTop());
      </script>

      <!-- 代码复制按钮 -->
      <script is:inline>
        document.addEventListener("astro:page-load", () => {
          document.querySelectorAll(".btn-copy").forEach((button) => {
            button.addEventListener("click", async () => {
              const codeBlock = button.closest(".frosti-code");
              const code = codeBlock.querySelector("code").textContent;
              const copyIcon = button.querySelector(".frosti-code-toolbar-copy-icon");
              const successIcon = button.querySelector(".frosti-code-toolbar-copy-success");
              try {
                await navigator.clipboard.writeText(code);
                copyIcon.classList.add("hidden");
                successIcon.classList.remove("hidden");
                button.classList.add("copy-success");
                setTimeout(() => {
                  copyIcon.classList.remove("hidden");
                  successIcon.classList.add("hidden");
                  button.classList.remove("copy-success");
                }, 2000);
              } catch (err) {
                console.error("Failed to copy:", err);
              }
            });
          });

          // 图片懒加载淡入效果
          document.querySelectorAll('img[loading="lazy"]').forEach((img) => {
            if (img.complete) {
              img.classList.add("loaded");
            } else {
              img.addEventListener("load", () => img.classList.add("loaded"));
            }
          });
        });

        // 监听解密事件，显示TOC
        document.addEventListener("blogDecrypted", () => {
          const tocWrapper = document.getElementById("toc-wrapper");
          if (tocWrapper) {
            tocWrapper.style.display = "";
          }
        });
      </script>

      <style is:inline>
        :root {
          --frosti-scroll-padding-top: 64px;
        }
        html {
          scroll-padding-top: var(--frosti-scroll-padding-top);
        }
        .btn-copy {
          position: relative;
          overflow: hidden;
        }
        .copy-success {
          animation: pulse 0.5s ease-in-out;
        }
        .frosti-code-toolbar-copy-success svg {
          color: #10b981;
        }
        @keyframes pulse {
          0% {
            transform: scale(1);
          }
          50% {
            transform: scale(1.1);
          }
          100% {
            transform: scale(1);
          }
        }
      </style>
    </div>
  </body>
</html>
